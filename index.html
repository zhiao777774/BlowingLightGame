<!DOCTYPE html>
<html lang='en'>

<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <script src='https://code.jquery.com/jquery-3.4.1.min.js'></script>
    <script src='https://www.gstatic.com/firebasejs/8.2.1/firebase-app.js'></script>
    <script src='https://www.gstatic.com/firebasejs/7.8.0/firebase-firestore.min.js'></script>
    <script src='https://cdn.bootcss.com/paho-mqtt/1.0.2/mqttws31.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js'></script>
    <script src="js/global.init.js"></script>
    <script src="js/firebase.config.js"></script>
    <script src="js/mqtt.config.js"></script>
    <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css'>
    <link rel='stylesheet' href='https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css'
        integrity='sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB' crossorigin='anonymous'>
    <link rel='stylesheet' href='css/global.css'>
    <title>吹氣燈遊戲</title>
</head>

<body onload='initMqttService()'>
    <main style='width: 100vw; height: 100vh;'>
        <nav class='d-none d-md-block navbar-nav bg-gradient-primary sidebar sidebar-dark accordion'>
            <div class='card-header'>
                <h4 class="sidebar-brand-text">吹氣燈遊戲</h4>
                <button id='btnSendToLine' class='btn btn-sm btn-success'>傳送遊玩結果至Line</button>
                <span id='mode-text'></span>
            </div>
            <div class='sidebar-sticky card-body'>
                <ul class='nav flex-column'></ul>
            </div>
        </nav>
        <div id="main-div">
        </div>
    </main>

    <script>
        const rendererList = {};
        let selfID = undefined;
        let preRenderer = undefined,
            currentPage = 1;

        (function (global, $) {
            'use strict';

            const Renderer = {};
            global.Renderer = Renderer || {};

            function execRendering(panelTitle, html, callback, ...args) {
                $('#main-div > div').each((i, div) => $(div).hide());

                const $body = $('#main-div').children(`div#main-div-body-${panelTitle}`);
                if ($body.length > 0) {
                    $body.show();
                } else {
                    $('#main-div').append(`<div id="main-div-body-${panelTitle}"></div>`);
                }
                $('#main-div').children(`div#main-div-body-${panelTitle}`).html(html);

                if (callback && $.isFunction(callback)) {
                    if (args.length > 0) callback.call(null, ...args);
                    else callback.call();
                }
            }

            Renderer.GameBoard = function () {
                this.rendererID = 'Gameboard';
                const collection = 'game-control';

                this.rendering = function () {
                    execRendering(this.rendererID, `
                    <h4 style="font-weight: bold; margin-bottom: 20px;">遊戲</h4>
                    <div id="gamebord-div" class="scrollbar">
                        <div class="row">
                            <div id="mode1-div" class="col-xl-12 col-lg-5">
                                <div class="card shadow mb-4">
                                    <!-- Card Header -->
                                    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                                        <h6 class="m-0 font-weight-bold text-primary">${gameMode[0]}</h6>
                                    </div>
                                    <!-- Card Body -->
                                    <div class="card-body">
                                        <div>
                                            <h5 class="bold" style="display: inline;">最近遊玩結果</h5>
                                            <span class="bold finish-text" style="color: red;">完成遊戲</span>
                                            <table class="table result-table">
                                                <thead>   
                                                    <tr> 
                                                        <th scope="col">時間</th>
                                                        <th scope="col">遊玩結果</th>
                                                    </tr>
                                                </thead>
                                                <tbody class="scrollbar"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div id="mode2-div" class="col-xl-12 col-lg-5">
                                <div class="card shadow mb-4">
                                    <!-- Card Header -->
                                    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                                        <h6 class="m-0 font-weight-bold text-primary">${gameMode[1]}</h6>
                                    </div>
                                    <!-- Card Body -->
                                    <div class="card-body">
                                        <div class="input-group">
                                            <input id="n-threshold" type="text" class="form-control" placeholder="請輸入門檻值(0~100)" aria-label="請輸入門檻值(0~100)">
                                            <div class="input-group-append">
                                                <button id="btnChangeThreshold" class="btn btn-primary">更改</button>
                                                <span id="text-threshold" class="btn disabled bold">現有門檻值</span>
                                            </div>
                                        </div>
                                        <hr />
                                        <div>
                                            <h5 class="bold" style="display: inline;">最近遊玩結果</h5>
                                            <span class="bold finish-text" style="color: red;">完成遊戲</span>
                                            <table class="table result-table">
                                                <thead>   
                                                    <tr> 
                                                        <th scope="col">時間</th>
                                                        <th scope="col">遊玩結果</th>
                                                    </tr>
                                                </thead>
                                                <tbody class="scrollbar"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div id="mode3-div" class="col-xl-12 col-lg-5">
                                <div class="card shadow mb-4">
                                    <!-- Card Header -->
                                    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                                        <h6 class="m-0 font-weight-bold text-primary">${gameMode[2]}</h6>
                                    </div>
                                    <!-- Card Body -->
                                    <div class="card-body">
                                        <div>
                                            <h5 class="bold" style="display: inline;">最近遊玩結果</h5>
                                            <span class="bold finish-text" style="color: red;">完成遊戲</span>
                                            <table class="table result-table">
                                                <thead>   
                                                    <tr> 
                                                        <th scope="col">時間</th>
                                                        <th scope="col">遊玩結果</th>
                                                    </tr>
                                                </thead>
                                                <tbody class="scrollbar"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    `);

                    FirebaseDB.onSnapshot(collection, () => _selectThreshold());

                    $('#gamebord-div > div.row div.card-header').click(function () {
                        $('#gamebord-div > div.row > div').removeClass('active');
                        $(this).parent().parent().addClass('active');

                        const currentMode = $(this).parent().parent().parent().index() + 1;
                        $('#mode-text').html('目前遊玩模式: ' +
                            `<span>${gameMode[currentMode - 1]}</span>`);
                        publishMessage('setModeToClient:' + currentMode);
                        /*$.get('/chageMode?mode=' + currentMode, (resp) => {
                            console.log(resp.error ? '失敗' : '成功');
                        });*/
                    });
                    $('#gamebord-div > div.row:nth-of-type(1) div.card-header').click();

                    FirebaseDB.onSnapshot('game-record', () => _selectRecords());

                    function _selectRecords() {
                        $('table.result-table tbody').empty();
                        FirebaseDB.get('game-record').then((docs) => {
                            let i = 1;
                            docs.forEach((doc) => {
                                const records = doc.data().records;
                                if (records.length) {
                                    const { date, result } = records[records.length - 1];
                                    $(`#gamebord-div > div.row:nth-of-type(${i++}) ` +
                                        'table.result-table tbody').append(`
                                        <tr>
                                            <td>${date}</td>
                                            <td>${result}</td>
                                        </tr>
                                        `);
                                }
                            });
                        });
                    }

                    $('#btnChangeThreshold').click(() => {
                        const threshold = Number($('#n-threshold').val());
                        if (!threshold) {
                            alert('請輸入欲更改的值');
                            return;
                        }

                        publishMessage('setThreshold:' + threshold);
                        FirebaseDB.update(collection, 'mode2', { threshold })
                            .then(() => {
                                alert('更改成功!');
                                $('#n-threshold').val('');
                            });
                    });

                    $('#n-threshold').keyup((e) => {
                        e = e.target;

                        if (!/^\d+$/.test(e.value)) {
                            $(e).val(/^\d+/.exec($(e).val()));
                        } else if (e.value <= 0 || e.value > 100) {
                            $(e).val('');
                        }

                        return false;
                    });

                    $('.finish-text').hide();

                    function _selectThreshold() {
                        FirebaseDB.get(collection).then((docs) => {
                            docs.forEach((doc) => {
                                const data = doc.data();
                                const threshold = data && data.threshold;
                                $('#text-threshold').text(`現有門檻值: ${threshold}`);
                            });
                        });
                    }
                };

                this.empty = function () {

                };
            };

            Renderer.GameRecord = function () {
                this.rendererID = 'GameRecord';
                const collection = 'game-record';

                this.rendering = function () {
                    execRendering(this.rendererID, `
                    <div>
                        <h4 style="font-weight: bold; margin-bottom: 20px;">遊玩紀錄</h4>
                        <table id="game-record-table" class="table scrollable">
                            <thead>   
                                <tr> 
                                    <th scope="col">#</th>
                                    <th scope="col">新增日期</th>
                                    <th scope="col">遊玩模式</th>
                                    <th scope="col">遊玩結果</th>
                                </tr>
                            </thead>
                            <tbody class="scrollbar"></tbody>
                        </table>
                    </div>
                    `);

                    FirebaseDB.onSnapshot(collection, () => _selectRecords());

                    function _selectRecords() {
                        FirebaseDB.get(collection).then((docs) => {
                            let count = 1;
                            $('#game-record-table tbody').empty();
                            docs.forEach((doc) => {
                                doc.data().records.forEach((d) => {
                                    const { date, mode, result } = d;
                                    $('#game-record-table tbody').append(`
                                    <tr>
                                        <td>${count++}</td>
                                        <td>${date}</td>
                                        <td>${mode}</td>
                                        <td>${result}</td>
                                    </tr>
                                    `);
                                });
                            });
                        });
                    }
                };

                this.empty = function () {

                };
            };

            Renderer.GameBattle = function () {
                this.rendererID = 'GameBattle';
                const collection = 'game-battle';

                this.rendering = function () {
                    execRendering(this.rendererID, `
                    <div>
                        <h4 style="font-weight: bold; margin-bottom: 20px;">雙人對決</h4>
                        <div class="input-group">
                            <input id="n-self-code" type="text" class="form-control" placeholder="請輸入編號" aria-label="請輸入編號">
                            <div class="input-group-append">
                                <button id="btnConfirmCode" class="btn btn-success">確定</button>
                            </div>
                        </div>
                        <div class="input-group" style="margin-top: 20px;">
                            <input id="n-battle-code" type="text" class="form-control" placeholder="請輸入對手編號" aria-label="請輸入對手編號">
                            <div class="input-group-append">
                                <button id="btnPair" class="btn btn-danger">配對</button>
                            </div>
                        </div>
                        <label id="pair-text" class="bold" style="margin-top: 15px"></label>
                        <hr />
                    </div>
                    `);

                    $('#btnConfirmCode').click(function () {
                        const id = $('#n-self-code').val();
                        if (!id) {
                            alert('請輸入編號');
                            return;
                        }

                        FirebaseDB.add(collection, { id }).then(() => {
                            selfID = id;
                            alert('成功');
                            $('#n-self-code').attr('disabled', true);
                            $(this).attr('disabled', true);
                        });
                    });

                    $('#btnPair').click(function () {
                        if (!selfID) {
                            alert('請先設定自己的編號');
                            return;
                        }

                        const id = $('#n-battle-code').val();
                        if (!id) {
                            alert('請輸入對手編號');
                            return;
                        }

                        FirebaseDB.ref(collection)
                            .where('id', '==', id)
                            .get().then((users) => {
                                if (users.size > 0) {
                                    users.forEach((user) => {
                                        user.ref.update({
                                            pair: selfID
                                        }).then(() => {
                                            alert('配對成功');
                                            user.ref.get().then((d) => {
                                                const opponentID = d.data().id;
                                                $('#pair-text').text(`配對: ${selfID} <-> ${opponentID}`);
                                            }); 
                                        });
                                    });

                                    return;
                                }

                                alert('對手不存在');
                            });
                    });
                };

                this.empty = function () {

                };
            };
        })(window, jQuery);
    </script>

    <script>
        const $ul = $('nav div.sidebar-sticky ul.nav.flex-column');
        const components = [{
            icon: 'gamepad fas',
            title: '遊戲'
        }, {
            icon: 'table fas',
            title: '遊玩紀錄'
        }, {
            icon: 'battle-net fab',
            title: '雙人對決'
        }];

        components.forEach(({ icon, title }) => {
            $ul.append(`
            <li class='nav-item'>
                <span class='nav-link'>
                    <i class="fa-${icon}"></i>
                    <span style='margin-left: 5px; font-weight: bold;'>${title}</span>
                </span>
            </li>`);
        });

        $ul.children('li').on('click', ({ target }) => {
            $ul.children().css('color', 'black');
            const $target = (function (t) {
                if ($(t).is('span.nav-link'))
                    return $(t).parent();
                else if ($(t).is('span'))
                    return $(t).parent().parent();
                return $(t);
            })(target);

            $ul.children(`li:nth-child(${$target.index() + 1})`).css('color', 'red');

            let title = $target.text().trim();
            changePage(title);
        });

        $ul.children('li').hover(({ target }) => {
            $ul.children('li span').css('color', 'rgba(245, 208, 22, .7)');
        }, ({ target }) => {
            $ul.children('li span').css('color', 'black');
        });

        $ul.children(':nth-child(1)').click();

        function changePage(title) {
            if (preRenderer) {
                console.log(preRenderer.rendererID);
                rendererList[preRenderer.rendererID].empty();
                rendererList[preRenderer.rendererID] = undefined;
            }

            let renderer;
            switch (title) {
                case '遊戲':
                    renderer = new Renderer.GameBoard();
                    break;
                case '遊玩紀錄':
                    renderer = new Renderer.GameRecord();
                    break;
                case '雙人對決':
                    renderer = new Renderer.GameBattle();
                    break;
                default:
                    return;
            }

            renderer.rendering();
            rendererList[renderer.rendererID] = preRenderer = renderer;
            console.log(rendererList);
        }

        $('#btnSendToLine').click(() => {
            FirebaseDB.get('game-record').then((docs) => {
                docs.forEach((doc) => {
                    const data = doc.data();
                    const records = data && data.records;
                    if (records.length > 0) {
                        const { date, mode, result } = records[records.length - 1];
                        const data = { value1: date, value2: mode, value3: result };
                        $.get('https://maker.ifttt.com/trigger/Game/with/key/dXBnGk8D01ODoNwKDBxfxb?' + $.param(data));
                    }
                });
                alert('Line訊息發送成功!');
            });
        });
    </script>
</body>

</html>